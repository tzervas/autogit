#!/usr/bin/env bash
# Pre-commit hook wrapper that auto-stages safe formatting changes
# This allows formatters to fix issues without blocking commits

set -e

echo "üîç Running pre-commit checks..."

# Run pre-commit but don't fail on formatting changes
if pre-commit run --hook-stage commit; then
    echo "‚úÖ All pre-commit checks passed!"
    exit 0
else
    EXIT_CODE=$?

    # Check if there are unstaged changes (from formatters)
    if git diff --name-only | grep -q .; then
        echo ""
        echo "üîß Auto-formatting applied changes to:"
        git diff --name-only | sed 's/^/   - /'
        echo ""
        echo "üìù Auto-staging formatting changes..."

        # Auto-stage files that were modified by formatters
        # Only stage files that were originally in the commit
        git diff --name-only | while read -r file; do
            if git diff --cached --name-only | grep -q "^${file}$" || [ -f "$file" ]; then
                git add "$file" 2> /dev/null || true
            fi
        done

        echo "‚úÖ Formatting changes staged automatically"
        echo "üí° Tip: Review changes with 'git diff --cached'"
        exit 0
    fi

    # If it's not a formatting issue, show the error
    echo ""
    echo "‚ùå Pre-commit checks failed (non-formatting issues)"
    echo "   Fix the issues above and try again"
    exit $EXIT_CODE
fi
