---
name: Auto Retry Failed Workflows

on:
  workflow_run:
    workflows: ["CI", "Docker Build and Test", "PR Validation", "Documentation Validation"]
    types:
      - completed

permissions:
  actions: write
  contents: read

jobs:
  auto-retry:
    name: Auto Retry Failed Workflow
    runs-on: self-hosted
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.run_attempt < 3
    steps:
      - name: Get workflow run details
        id: get_run
        run: |
          echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          echo "run_attempt=${{ github.event.workflow_run.run_attempt }}" >> $GITHUB_OUTPUT
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT

      - name: Wait before retry
        run: |
          # Wait 30 seconds before retrying to avoid immediate re-failure
          echo "Waiting 30 seconds before retrying..."
          sleep 30

      - name: Retry failed workflow
        uses: actions/github-script@v8
        with:
          script: |
            const runId = ${{ github.event.workflow_run.id }};
            const runAttempt = ${{ github.event.workflow_run.run_attempt }};
            const workflowName = '${{ github.event.workflow_run.name }}';

            console.log(`Retrying ${workflowName} (run ${runId}, attempt ${runAttempt})`);

            try {
              await github.rest.actions.reRunWorkflowFailedJobs({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });

              console.log(`‚úì Successfully triggered retry for ${workflowName}`);

              // Add comment to PR if this is a PR workflow
              if (context.payload.workflow_run.pull_requests.length > 0) {
                const prNumber = context.payload.workflow_run.pull_requests[0].number;

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `üîÑ Automatically retrying failed ${workflowName} workflow (attempt ${runAttempt + 1}/3)`
                });
              }
            } catch (error) {
              console.error(`‚úó Failed to retry workflow: ${error.message}`);
              throw error;
            }

      - name: Notify if max retries reached
        if: github.event.workflow_run.run_attempt >= 3
        uses: actions/github-script@v8
        with:
          script: |
            if (context.payload.workflow_run.pull_requests.length > 0) {
              const prNumber = context.payload.workflow_run.pull_requests[0].number;
              const workflowName = '${{ github.event.workflow_run.name }}';
              const attemptNumber = context.payload.workflow_run.run_attempt;
              const failureCount = attemptNumber - 1; // First attempt is not a failure

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `‚ö†Ô∏è **${workflowName}** has reached the maximum retry limit.\n\n` +
                      `**Status**: Failed ${failureCount} time(s), attempted ${attemptNumber} time(s) total.\n` +
                      `**Action Required**: Manual intervention is needed.\n\n` +
                      `Please review the workflow logs and fix any issues:\n` +
                      `${context.payload.workflow_run.html_url}`
              });

              // Add needs-attention label with error handling
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: ['needs-attention']
                });
              } catch (error) {
                if (error.status === 404) {
                  // Label doesn't exist yet, create it
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: 'needs-attention',
                    color: 'd93f0b',
                    description: 'Failed multiple times and needs manual review'
                  });

                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    labels: ['needs-attention']
                  });
                } else {
                  core.warning(`Failed to add "needs-attention" label: ${error.message}`);
                }
              }
            }
