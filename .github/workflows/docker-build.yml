---
name: Docker Build and Test

on:
  pull_request:
    branches:
      - main
      - dev
      - 'feature/**'
    paths:
      - 'services/**'
      - 'docker-compose.yml'
      - '.github/workflows/docker-build.yml'
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  build-git-server:
    name: Build Git Server Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for caching
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/git-server
          tags: |
            type=ref,event=pr
            type=ref,event=branch
            type=sha

      - name: Build Git Server (with GHCR layer caching)
        uses: docker/build-push-action@v5
        with:
          context: ./services/git-server
          file: ./services/git-server/Dockerfile
          push: false
          tags: autogit-git-server:test
          cache-from: |
            type=registry,ref=ghcr.io/${{ github.repository }}/git-server:cache
            type=gha
          cache-to: type=gha,mode=max

  build-runner-coordinator:
    name: Build Runner Coordinator Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for caching
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/runner-coordinator
          tags: |
            type=ref,event=pr
            type=ref,event=branch
            type=sha

      - name: Build Runner Coordinator (with GHCR layer caching)
        uses: docker/build-push-action@v5
        with:
          context: ./services/runner-coordinator
          file: ./services/runner-coordinator/Dockerfile
          push: false
          tags: autogit-runner-coordinator:test
          cache-from: |
            type=registry,ref=ghcr.io/${{ github.repository }}/runner-coordinator:cache
            type=gha
          cache-to: type=gha,mode=max

  test-docker-compose:
    name: Test Docker Compose Configuration
    runs-on: ubuntu-latest
    needs: [build-git-server, build-runner-coordinator]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cp services/git-server/.env.example .env
          # Set test password for CI
          sed -i 's/CHANGE_ME_SECURE_PASSWORD/TestPassword123!/' .env

      - name: Validate docker-compose
        run: |
          docker compose config

      - name: Build services
        run: |
          docker compose build

      - name: Test service startup (git-server only for CI)
        run: |
          # Start only git-server for testing (runner-coordinator requires docker socket)
          docker compose up -d git-server

          # Wait for service to be healthy (with timeout)
          echo "Waiting for git-server to be healthy..."
          for i in {1..30}; do
            if docker compose ps git-server | grep -q "healthy"; then
              echo "✓ Git server is healthy"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "✗ Git server failed to become healthy"
              docker compose logs git-server
              exit 1
            fi
            echo "  Attempt $i/30: Waiting..."
            sleep 10
          done

      - name: Check service logs
        if: always()
        run: |
          docker compose logs git-server

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
