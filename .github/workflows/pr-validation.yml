---
name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches:
      - main
      - dev
      - 'feature/**'

permissions:
  contents: read

jobs:
  validate-branch-naming:
    name: Validate Branch Naming Convention
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate branch name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Validating branch name: $BRANCH_NAME"

          # Valid branch patterns:
          # - main
          # - dev
          # - feature/<name>
          # - feature/<name>/<subtask>
          # - feature/<name>/<subtask>/<work-item>
          # - hotfix/<name>
          # - release/<version>

          if [[ "$BRANCH_NAME" =~ ^(main|dev)$ ]] || \
             [[ "$BRANCH_NAME" =~ ^feature/[a-z0-9-]+(/[a-z0-9-]+)?(/[a-z0-9-]+)?$ ]] || \
             [[ "$BRANCH_NAME" =~ ^hotfix/[a-z0-9-]+$ ]] || \
             [[ "$BRANCH_NAME" =~ ^release/[0-9]+\.[0-9]+\.[0-9]+$ ]] || \
             [[ "$BRANCH_NAME" =~ ^copilot/[a-z0-9-]+$ ]]; then
            echo "✓ Branch name is valid"
          else
            echo "✗ Invalid branch name: $BRANCH_NAME"
            echo ""
            echo "Valid patterns:"
            echo "  - feature/<feature-name>"
            echo "  - feature/<feature-name>/<subtask>"
            echo "  - feature/<feature-name>/<subtask>/<work-item>"
            echo "  - hotfix/<name>"
            echo "  - release/<version>"
            echo "  - copilot/<name>"
            echo ""
            echo "See docs/development/branching-strategy.md for details"
            exit 1
          fi

  validate-pr-target:
    name: Validate PR Target Branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate PR target
        run: |
          SOURCE="${{ github.head_ref }}"
          TARGET="${{ github.base_ref }}"

          echo "Source branch: $SOURCE"
          echo "Target branch: $TARGET"

          # Validate merge hierarchy:
          # - feature/x/y/z → feature/x/y (work → subtask)
          # - feature/x/y → feature/x (subtask → feature)
          # - feature/x → dev (feature → dev)
          # - dev → main (release)
          # - hotfix/x → main (hotfix)
          # - release/x → main (release)

          # Work branch → Subtask
          if [[ "$SOURCE" =~ ^feature/([^/]+)/([^/]+)/([^/]+)$ ]]; then
            EXPECTED="feature/${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
            if [[ "$TARGET" == "$EXPECTED" ]]; then
              echo "✓ Valid: work branch → subtask"
              exit 0
            fi
          fi

          # Subtask → Feature
          if [[ "$SOURCE" =~ ^feature/([^/]+)/([^/]+)$ ]]; then
            EXPECTED="feature/${BASH_REMATCH[1]}"
            if [[ "$TARGET" == "$EXPECTED" ]]; then
              echo "✓ Valid: subtask → feature"
              exit 0
            fi
          fi

          # Feature → Dev
          if [[ "$SOURCE" =~ ^feature/([^/]+)$ ]]; then
            if [[ "$TARGET" == "dev" ]]; then
              echo "✓ Valid: feature → dev"
              exit 0
            fi
          fi

          # Dev → Main (release)
          if [[ "$SOURCE" == "dev" ]] && [[ "$TARGET" == "main" ]]; then
            echo "✓ Valid: dev → main (release)"
            exit 0
          fi

          # Hotfix → Main
          if [[ "$SOURCE" =~ ^hotfix/ ]] && [[ "$TARGET" == "main" ]]; then
            echo "✓ Valid: hotfix → main"
            exit 0
          fi

          # Release → Main
          if [[ "$SOURCE" =~ ^release/ ]] && [[ "$TARGET" == "main" ]]; then
            echo "✓ Valid: release → main"
            exit 0
          fi

          # Copilot branches → dev (temporary)
          if [[ "$SOURCE" =~ ^copilot/ ]] && [[ "$TARGET" == "dev" ]]; then
            echo "✓ Valid: copilot → dev (temporary workflow)"
            exit 0
          fi

          # If we get here, invalid hierarchy
          echo "✗ Invalid PR target"
          echo ""
          echo "Source: $SOURCE"
          echo "Target: $TARGET"
          echo ""
          echo "Valid merge patterns:"
          echo "  - feature/x/y/z → feature/x/y (work → subtask)"
          echo "  - feature/x/y → feature/x (subtask → feature)"
          echo "  - feature/x → dev (feature → dev)"
          echo "  - dev → main (release)"
          echo "  - hotfix/x → main"
          echo "  - release/x → main"
          echo ""
          echo "See docs/development/branching-strategy.md for details"
          exit 1

  check-pr-description:
    name: Check PR Description
    runs-on: ubuntu-latest
    steps:
      - name: Check PR has description
        run: |
          DESCRIPTION="${{ github.event.pull_request.body }}"

          if [[ -z "$DESCRIPTION" ]] || [[ "$DESCRIPTION" == "null" ]]; then
            echo "⚠ Warning: PR has no description"
            echo "Consider adding a description using the appropriate PR template:"
            echo "  - .github/PULL_REQUEST_TEMPLATE/work_template.md"
            echo "  - .github/PULL_REQUEST_TEMPLATE/sub_feature_template.md"
            echo "  - .github/PULL_REQUEST_TEMPLATE/feature_template.md"
            echo "  - .github/PULL_REQUEST_TEMPLATE/release_template.md"
          else
            echo "✓ PR has description"
          fi
          # Always succeed (description check is informational only)
          exit 0
