---
name: Automated Versioning

# This workflow creates version tags for the repository
# It runs when:
# 1. PR is merged into main (production releases)
# 2. PR is merged into dev (development pre-releases)
# 
# Only triggers if there are actual code changes (excludes docs-only changes)

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - dev

jobs:
  check-changes:
    name: Check for Code Changes
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    outputs:
      has_code_changes: ${{ steps.check_files.outputs.has_code_changes }}
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for code changes
        id: check_files
        run: |
          # Get list of changed files in the PR
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "Checking files changed in PR #$PR_NUMBER..."
          
          # Get changed files using GitHub API
          CHANGED_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path')
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Define patterns for non-code files (documentation, CI configs, etc.)
          # These patterns won't trigger versioning
          NON_CODE_PATTERNS=(
            "*.md"
            "docs/"
            ".github/workflows/"
            ".gitignore"
            "LICENSE"
            "CHANGELOG.md"
            "README.md"
            "*.txt"
          )
          
          HAS_CODE_CHANGES="false"
          
          # Check each changed file
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            IS_CODE_FILE="true"
            
            # Check if file matches any non-code pattern
            for pattern in "${NON_CODE_PATTERNS[@]}"; do
              if [[ "$file" == $pattern ]]; then
                IS_CODE_FILE="false"
                echo "  ⏭️  Non-code file: $file"
                break
              fi
            done
            
            if [ "$IS_CODE_FILE" = "true" ]; then
              echo "  ✅ Code file found: $file"
              HAS_CODE_CHANGES="true"
              break
            fi
          done <<< "$CHANGED_FILES"
          
          if [ "$HAS_CODE_CHANGES" = "true" ]; then
            echo "✅ Code changes detected - versioning will proceed"
          else
            echo "ℹ️  No code changes detected - skipping versioning"
          fi
          
          echo "has_code_changes=$HAS_CODE_CHANGES" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  tag-version:
    name: Create Version Tag
    needs: check-changes
    if: needs.check-changes.outputs.has_code_changes == 'true'
    runs-on: self-hosted
    permissions:
      contents: write
      actions: write  # Required to trigger release workflow when pushing tags
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run Versioning Script
        run: |
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          echo "Creating version tag for branch: $TARGET_BRANCH"
          
          # Checkout the target branch
          git checkout "$TARGET_BRANCH"
          git pull origin "$TARGET_BRANCH"
          
          # Run the versioning script
          ./scripts/automate-version.sh
        env:
          TARGET_BRANCH: ${{ github.event.pull_request.base.ref }}
