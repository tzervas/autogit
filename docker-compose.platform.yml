# AutoGit Platform - Master Orchestration
# ═══════════════════════════════════════════════════════════════════════════════
# Single docker-compose for the complete platform
# Configure via .env file (see .env.example)
#
# Usage:
#   docker compose up -d                    # Start all services
#   docker compose --profile observability  # Include monitoring stack
#   docker compose --profile gpu            # Include GPU runners
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # INGRESS LAYER - Traefik Reverse Proxy
  # ═══════════════════════════════════════════════════════════════════════════
  traefik:
    image: traefik:v3.0
    container_name: autogit-ingress
    restart: unless-stopped
    command:
      # API & Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"

      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=autogit-network"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"

      # HTTP → HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=${DNS_PROVIDER:-cloudflare}"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"

      # Logging
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"

    environment:
      # DNS Provider credentials (for Let's Encrypt DNS challenge)
      - CF_API_EMAIL=${CF_API_EMAIL:-}
      - CF_API_KEY=${CF_API_KEY:-}
      # Or use token:
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN:-}

    ports:
      - "80:80"
      - "443:443"
      # Dashboard (internal only - access via subdomain)
      # - "8080:8080"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-acme:/acme
      - traefik-logs:/var/log/traefik
      - ./traefik/dynamic:/etc/traefik/dynamic:ro

    networks:
      - autogit-network

    labels:
      # Dashboard routing
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${BASE_DOMAIN}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.tls.domains[0].main=${BASE_DOMAIN}"
      - "traefik.http.routers.dashboard.tls.domains[0].sans=*.${BASE_DOMAIN}"
      - "traefik.http.routers.dashboard.middlewares=auth"

      # Basic auth for dashboard (generate: htpasswd -nb admin password)
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_AUTH:-admin:$$apr1$$ruca84Hq$$mbjdMZBAG.KWn7vfN/SNK.}"

  # ═══════════════════════════════════════════════════════════════════════════
  # GITLAB - Git Server & CI/CD
  # ═══════════════════════════════════════════════════════════════════════════
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: autogit-gitlab
    restart: unless-stopped
    hostname: 'gitlab.${BASE_DOMAIN}'

    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.${BASE_DOMAIN}'

        # Puma configuration (unix socket to avoid port conflicts)
        puma['bind'] = 'unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket'
        puma['port'] = nil

        # Let Traefik handle SSL
        nginx['listen_port'] = 80
        nginx['listen_https'] = false
        nginx['proxy_set_headers'] = {
          "X-Forwarded-Proto" => "https",
          "X-Forwarded-Ssl" => "on"
        }

        # SSH (direct port, not through Traefik)
        gitlab_rails['gitlab_shell_ssh_port'] = ${SSH_PORT:-2222}

        # Performance tuning (homelab preset)
        puma['worker_processes'] = ${GITLAB_PUMA_WORKERS:-2}
        puma['max_threads'] = ${GITLAB_PUMA_THREADS:-4}
        sidekiq['concurrency'] = ${GITLAB_SIDEKIQ_CONCURRENCY:-6}
        postgresql['shared_buffers'] = "${GITLAB_PG_SHARED_BUFFERS:-1GB}"

        # Disable unnecessary features
        prometheus_monitoring['enable'] = false
        gitlab_exporter['enable'] = false
        registry['enable'] = ${GITLAB_REGISTRY_ENABLED:-false}

    ports:
      - "${SSH_PORT:-2222}:22"

    volumes:
      - gitlab-config:/etc/gitlab
      - gitlab-logs:/var/log/gitlab
      - gitlab-data:/var/opt/gitlab

    shm_size: '${GITLAB_SHM_SIZE:-2gb}'

    deploy:
      resources:
        limits:
          cpus: '${GITLAB_CPU_LIMIT:-6.0}'
          memory: ${GITLAB_MEMORY_LIMIT:-6G}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/-/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

    networks:
      - autogit-network

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitlab.rule=Host(`gitlab.${BASE_DOMAIN}`)"
      - "traefik.http.routers.gitlab.tls.certresolver=letsencrypt"
      - "traefik.http.services.gitlab.loadbalancer.server.port=80"

  # ═══════════════════════════════════════════════════════════════════════════
  # AUTOGIT API - Platform Management API
  # ═══════════════════════════════════════════════════════════════════════════
  api:
    image: autogit-api:latest
    build:
      context: ./src
      dockerfile: Dockerfile
    container_name: autogit-api
    restart: unless-stopped

    environment:
      - BASE_DOMAIN=${BASE_DOMAIN}
      - GITLAB_URL=http://gitlab
      - GITLAB_TOKEN=${GITLAB_API_TOKEN:-}
      - LOG_LEVEL=${API_LOG_LEVEL:-INFO}
      - DATABASE_URL=sqlite:///data/autogit.db

    volumes:
      - api-data:/data
      - ./credentials:/credentials:ro

    deploy:
      resources:
        limits:
          cpus: '${API_CPU_LIMIT:-1.0}'
          memory: ${API_MEMORY_LIMIT:-512M}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

    networks:
      - autogit-network

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.${BASE_DOMAIN}`)"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=8000"

    profiles:
      - api

  # ═══════════════════════════════════════════════════════════════════════════
  # OBSERVABILITY STACK
  # ═══════════════════════════════════════════════════════════════════════════

  # Grafana - Dashboards & Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: autogit-grafana
    restart: unless-stopped

    environment:
      - GF_SERVER_ROOT_URL=https://grafana.${BASE_DOMAIN}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-piechart-panel

    volumes:
      - grafana-data:/var/lib/grafana
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards:ro

    deploy:
      resources:
        limits:
          cpus: '${GRAFANA_CPU_LIMIT:-1.0}'
          memory: ${GRAFANA_MEMORY_LIMIT:-512M}

    networks:
      - autogit-network

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${BASE_DOMAIN}`)"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

    profiles:
      - observability

  # Loki - Log Aggregation
  loki:
    image: grafana/loki:latest
    container_name: autogit-loki
    restart: unless-stopped

    command: -config.file=/etc/loki/loki-config.yml

    volumes:
      - loki-data:/loki
      - ./observability/loki/loki-config.yml:/etc/loki/loki-config.yml:ro

    deploy:
      resources:
        limits:
          cpus: '${LOKI_CPU_LIMIT:-2.0}'
          memory: ${LOKI_MEMORY_LIMIT:-1G}

    networks:
      - autogit-network

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.loki.rule=Host(`loki.${BASE_DOMAIN}`)"
      - "traefik.http.routers.loki.tls.certresolver=letsencrypt"
      - "traefik.http.services.loki.loadbalancer.server.port=3100"

    profiles:
      - observability

  # Promtail - Log Collector
  promtail:
    image: grafana/promtail:latest
    container_name: autogit-promtail
    restart: unless-stopped

    command: -config.file=/etc/promtail/promtail-config.yml

    volumes:
      - /var/log:/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./observability/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml:ro

    networks:
      - autogit-network

    profiles:
      - observability

  # Tempo - Distributed Tracing
  tempo:
    image: grafana/tempo:latest
    container_name: autogit-tempo
    restart: unless-stopped

    command: -config.file=/etc/tempo/tempo-config.yml

    volumes:
      - tempo-data:/var/tempo
      - ./observability/tempo/tempo-config.yml:/etc/tempo/tempo-config.yml:ro

    deploy:
      resources:
        limits:
          cpus: '${TEMPO_CPU_LIMIT:-1.0}'
          memory: ${TEMPO_MEMORY_LIMIT:-512M}

    networks:
      - autogit-network

    profiles:
      - observability

  # Prometheus - Metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: autogit-prometheus
    restart: unless-stopped

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'

    volumes:
      - prometheus-data:/prometheus
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro

    deploy:
      resources:
        limits:
          cpus: '${PROMETHEUS_CPU_LIMIT:-2.0}'
          memory: ${PROMETHEUS_MEMORY_LIMIT:-1G}

    networks:
      - autogit-network

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${BASE_DOMAIN}`)"
      - "traefik.http.routers.prometheus.tls.certresolver=letsencrypt"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

    profiles:
      - observability

  # Meilisearch - Semantic Search
  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: autogit-meilisearch
    restart: unless-stopped

    environment:
      - MEILI_MASTER_KEY=${MEILISEARCH_MASTER_KEY:-}
      - MEILI_ENV=production

    volumes:
      - meilisearch-data:/meili_data

    deploy:
      resources:
        limits:
          cpus: '${MEILISEARCH_CPU_LIMIT:-2.0}'
          memory: ${MEILISEARCH_MEMORY_LIMIT:-1G}

    networks:
      - autogit-network

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.search.rule=Host(`search.${BASE_DOMAIN}`)"
      - "traefik.http.routers.search.tls.certresolver=letsencrypt"
      - "traefik.http.services.search.loadbalancer.server.port=7700"

    profiles:
      - observability

  # ═══════════════════════════════════════════════════════════════════════════
  # GITLAB RUNNER - CPU
  # ═══════════════════════════════════════════════════════════════════════════
  runner-cpu:
    image: gitlab/gitlab-runner:latest
    container_name: autogit-runner-cpu
    restart: unless-stopped

    volumes:
      - runner-cpu-config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock

    depends_on:
      gitlab:
        condition: service_healthy

    networks:
      - autogit-network

    profiles:
      - runner

# ═══════════════════════════════════════════════════════════════════════════════
# NETWORKS
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  autogit-network:
    driver: bridge

# ═══════════════════════════════════════════════════════════════════════════════
# VOLUMES
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  # Ingress
  traefik-acme:
  traefik-logs:

  # GitLab
  gitlab-config:
  gitlab-logs:
  gitlab-data:

  # API
  api-data:

  # Observability
  grafana-data:
  loki-data:
  tempo-data:
  prometheus-data:
  meilisearch-data:

  # Runners
  runner-cpu-config:
