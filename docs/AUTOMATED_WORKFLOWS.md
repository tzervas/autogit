# Automated Workflow System

This document describes the automated workflow system that ensures code quality, proper versioning, and verified commits.

## Overview

The AutoGit repository now includes a comprehensive automation system that:

1. **Auto-fixes code** before commits using pre-commit hooks
2. **Validates and signs commits** to ensure authenticity
3. **Automatically versions releases** based on branch and changes
4. **Triggers release workflows** when tags are pushed
5. **Annotates commits** with details about automated fixes

## Components

### 1. Pre-commit Hooks

Pre-commit hooks automatically run before each commit to:

- Fix trailing whitespace and line endings
- Format code (Python with Black, shell scripts with shfmt)
- Validate YAML, JSON, and TOML syntax
- Check for secrets and private keys
- Lint shell scripts with shellcheck
- Validate commit messages follow conventional format

**Setup:**
```bash
./scripts/setup-pre-commit.sh
```

**Manual run:**
```bash
pre-commit run --all-files
```

### 2. Pre-commit Auto-fix Workflow

The `.github/workflows/pre-commit-auto-fix.yml` workflow runs on all pull requests to:

- Automatically detect code style issues
- Apply fixes using pre-commit hooks
- Commit fixes back to the PR branch
- Comment on the PR with details about fixes applied

**Trigger:** Automatically on PR open, sync, or reopen

**What it fixes:**
- Code formatting
- YAML/JSON syntax
- Shell script formatting
- Python code style (Black, isort)
- Trailing whitespace and line endings

### 3. Versioning Workflow

The `.github/workflows/versioning.yml` workflow creates version tags when:

- PRs are merged into `main` (production releases)
- PRs are merged into `dev` (development pre-releases)

**Version Format:**
- Main branch: `vX.Y.Z` (e.g., `v0.3.0`)
- Dev branch: `vX.Y.Z-dev.TIMESTAMP` (e.g., `v0.3.0-dev.20241225`)

**Code Change Detection:**
The workflow only creates versions when actual code changes are detected (excluding docs, CI configs, etc.)

### 4. Release Workflow

The `.github/workflows/release.yml` workflow creates GitHub releases and publishes Docker images when:

- A version tag is pushed (triggered by versioning workflow)
- Manually triggered via workflow_dispatch

**Features:**
- Automatic version detection from tags or PR titles
- Release notes generation from PR descriptions
- Multi-architecture Docker image builds
- Layer caching for efficient builds

### 5. Commit Signing

All commits are verified and signed:

**GitHub Actions:**
- Commits from GitHub Actions are automatically signed by GitHub
- Uses `github-actions[bot]` identity
- No GPG configuration needed

**Local Development:**
```bash
./scripts/setup-git-signing.sh
```

This script:
- Configures commit message template
- Sets up GPG signing if available
- Provides instructions for key generation

## Workflow Chain

The complete workflow chain looks like this:

```
Developer commits â†’ Pre-commit hooks run
                  â†“
            Fixes applied automatically
                  â†“
              Commit succeeds
                  â†“
            Push to feature branch
                  â†“
         Create PR to dev/main
                  â†“
      Pre-commit auto-fix workflow runs
                  â†“
         PR reviewed and merged
                  â†“
       Versioning workflow triggers
                  â†“
         Version tag is created
                  â†“
       Release workflow triggers
                  â†“
    GitHub release + Docker images published
```

## Commit Message Format

All commits must follow the [Conventional Commits](https://www.conventionalcommits.org/) format:

```
<type>(<scope>): <subject>

[optional body]

[optional footer]
```

**Types:**
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation changes
- `style`: Code style changes (formatting)
- `refactor`: Code refactoring
- `perf`: Performance improvements
- `test`: Test changes
- `chore`: Build/tool changes
- `ci`: CI/CD changes

**Examples:**
```
feat(runners): add GPU detection and allocation
fix(auth): resolve token refresh race condition
docs(readme): update installation instructions
ci(workflows): optimize Docker build caching
```

## Automated Fix Annotations

When pre-commit hooks or workflows apply fixes, the commit message includes:

- List of files modified
- Type of fixes applied
- Automated signature

**Example commit message:**
```
style: Apply automated code fixes

Auto-fixes applied by pre-commit hooks:

- services/runner-coordinator/main.py
- scripts/automate-version.sh
- .github/workflows/release.yml

ðŸ¤– This commit was automatically generated by GitHub Actions
âœ¨ All fixes follow project coding standards
```

## Troubleshooting

### Pre-commit hook failures

If pre-commit hooks fail:

1. Review the error message
2. Fix the issue manually if needed
3. Run `pre-commit run --all-files` to verify
4. Commit again

**Skip hooks (not recommended):**
```bash
git commit --no-verify
```

### Workflow trigger issues

If workflows don't trigger:

1. Check workflow permissions in repository settings
2. Verify "Allow GitHub Actions to create and approve pull requests" is enabled
3. Check workflow logs for errors

### Commit signing issues

If commits aren't signed:

**For GitHub Actions:**
- Commits are automatically signed by GitHub
- No action needed

**For local development:**
```bash
# Generate GPG key
gpg --full-generate-key

# Configure git
git config user.signingkey YOUR_KEY_ID
git config commit.gpgsign true

# Add GPG key to GitHub
gpg --armor --export YOUR_KEY_ID
# Copy output and add to GitHub â†’ Settings â†’ SSH and GPG keys
```

## Best Practices

1. **Always run setup scripts:**
   ```bash
   ./scripts/setup-pre-commit.sh
   ./scripts/setup-git-signing.sh
   ```

2. **Let pre-commit fix issues:**
   - Don't skip pre-commit hooks
   - Review auto-fixes before pushing

3. **Use conventional commit format:**
   - Use the commit template (`.gitmessage`)
   - Be specific in scope and subject

4. **Review automated PR fixes:**
   - Check the auto-fix commits in PRs
   - Ensure they're correct before merging

5. **Monitor workflow runs:**
   - Check Actions tab for workflow status
   - Address failures promptly

## Configuration Files

- `.pre-commit-config.yaml` - Pre-commit hooks configuration
- `.gitmessage` - Commit message template
- `.github/workflows/pre-commit-auto-fix.yml` - Auto-fix workflow
- `.github/workflows/versioning.yml` - Versioning workflow
- `.github/workflows/release.yml` - Release workflow
- `scripts/setup-pre-commit.sh` - Pre-commit setup script
- `scripts/setup-git-signing.sh` - Git signing setup script
- `scripts/automate-version.sh` - Versioning script

## References

- [Conventional Commits](https://www.conventionalcommits.org/)
- [Pre-commit](https://pre-commit.com/)
- [GitHub Actions](https://docs.github.com/en/actions)
- [Semantic Versioning](https://semver.org/)
- [GPG Signing](https://docs.github.com/en/authentication/managing-commit-signature-verification)
