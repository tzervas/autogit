# CI/CD Secrets Configuration

This document describes the secrets and CI/CD variables required for the AutoGit CI/CD pipelines.

## Overview

AutoGit uses a dual CI/CD strategy:
- **GitHub Actions** for PR validation and public-facing workflows
- **GitLab CI** (self-hosted) for container builds and internal deployments

Both systems require proper secret configuration for secure operation.

---

## GitLab CI/CD Variables

Configure these in **GitLab** > **Settings** > **CI/CD** > **Variables**.

### Required Variables for GHCR Publishing

| Variable | Description | Type | Protected | Masked |
|----------|-------------|------|-----------|--------|
| `GHCR_USER` | GitHub username for GHCR authentication | Variable | ✅ Yes | ❌ No |
| `GHCR_TOKEN` | GitHub PAT with `packages:write` scope | Variable | ✅ Yes | ✅ Yes |

### Automatic Variables (No Configuration Needed)

GitLab provides these automatically for registry authentication:

| Variable | Description |
|----------|-------------|
| `CI_REGISTRY` | GitLab Container Registry URL |
| `CI_REGISTRY_IMAGE` | Full path to project image |
| `CI_JOB_TOKEN` | Scoped token for registry push/pull |
| `CI_REGISTRY_USER` | Set to `gitlab-ci-token` |

### Setting Up GHCR Token

1. Go to GitHub > **Settings** > **Developer settings** > **Personal access tokens** > **Tokens (classic)**
2. Click **Generate new token (classic)**
3. Give it a descriptive name like `autogit-gitlab-ci-ghcr`
4. Set expiration (recommended: 90 days, then rotate)
5. Select scopes:
   - ✅ `write:packages` - Push packages to GHCR
   - ✅ `read:packages` - Pull packages from GHCR
   - ✅ `delete:packages` - (Optional) Delete old package versions
6. Click **Generate token** and copy the value
7. Add to GitLab CI/CD Variables as `GHCR_TOKEN` (masked, protected)

---

## GitHub Actions Secrets

Configure these in **GitHub** > **Settings** > **Secrets and variables** > **Actions**.

### Repository Secrets

| Secret | Description | Required For |
|--------|-------------|--------------|
| `GITLAB_API_TOKEN` | GitLab API token for pipeline status | Self-hosted CI status checks |
| `GHCR_TOKEN` | GitHub PAT for container publishing | GitHub container builds (if enabled) |

### Automatic Secrets

GitHub provides these automatically:

| Secret | Description |
|--------|-------------|
| `GITHUB_TOKEN` | Auto-generated token for workflow operations |
| `secrets.GITHUB_TOKEN` | Same as above, scoped to repository |

---

## Security Best Practices

### Token Scoping

1. **Minimum Privilege**: Only grant required permissions
2. **Token Rotation**: Rotate tokens every 90 days
3. **Protected Variables**: Mark sensitive vars as "Protected" to only expose on protected branches
4. **Masked Variables**: Mark secrets as "Masked" to prevent exposure in logs

### Token Types Comparison

| Token Type | Use Case | Lifetime | Scope |
|------------|----------|----------|-------|
| `CI_JOB_TOKEN` | GitLab Registry access | Job duration | Single job |
| GitHub PAT (classic) | Cross-platform auth | Configurable | User-defined |
| GitHub App Token | GitHub Actions | Workflow run | Repository |

### Environment Separation

```
Production (main branch):
├── Protected variables only
├── Masked secrets enabled
└── No manual variable exposure

Development (dev, feature/*):
├── All CI/CD variables
├── May include debug vars
└── Still masked secrets
```

---

## Troubleshooting

### GitLab Registry Authentication Fails

**Error**: `UNAUTHORIZED: HTTP Basic: Access denied`

**Solutions**:
1. Ensure `CI_REGISTRY` is set (indicates Container Registry is enabled)
2. Check if the project has Container Registry enabled in Settings
3. Verify `CI_JOB_TOKEN` has push permissions

### GHCR Authentication Fails

**Error**: `unauthorized: authentication required`

**Solutions**:
1. Verify `GHCR_USER` and `GHCR_TOKEN` are set in CI/CD Variables
2. Check token hasn't expired
3. Verify token has `write:packages` scope
4. Ensure token is for the correct GitHub account

### Masked Variable Not Working

**Symptom**: Secret appears in logs

**Solutions**:
1. GitLab requires masked values to be:
   - At least 8 characters
   - No newlines
   - Base64-safe characters
2. Re-add the variable with masking enabled

---

## Variable Quick Reference

```yaml
# GitLab CI - Uses these automatically
CI_REGISTRY: registry.gitlab.com  # or self-hosted URL
CI_REGISTRY_IMAGE: registry.gitlab.com/user/project
CI_JOB_TOKEN: <auto-generated>

# GHCR - Must be configured manually
GHCR_REGISTRY: ghcr.io
GHCR_REPO: tzervas/autogit
GHCR_USER: <your-github-username>
GHCR_TOKEN: <your-github-pat>
```

---

## See Also

- [GitLab CI/CD Variables Documentation](https://docs.gitlab.com/ee/ci/variables/)
- [GitHub Encrypted Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [GHCR Authentication](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry)
