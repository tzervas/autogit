# AutoGit Security & Credentials Management

## Overview

AutoGit implements secure credential management with **automatic password generation** and **secure storage practices**. All sensitive data is kept out of version control and stored with appropriate file permissions.

## Automatic Password Generation

### GitLab Root Password

The GitLab root user password is **automatically generated** on first setup:

```bash
# Run first-time setup
bash scripts/first-time-setup-complete.sh
```

This generates a **32-character random password** using cryptographically secure random data:

```bash
openssl rand -base64 32 | tr -d "=+/" | cut -c1-32
```

### Password Storage

The password is stored in:
```
~/.autogit/gitlab_root_password
```

With permissions: `600` (readable only by owner)

## Credential Files

### Location: `~/.autogit/`

All credentials are stored in your home directory:

```
~/.autogit/
├── gitlab_root_password    # GitLab root password (600)
└── (future tokens)
```

### Location: Project Root

Configuration files in the project root:

```
.env                    # Environment variables (600)
.env.gitlab             # GitLab integration config (600)
.autogit_secrets        # Legacy secrets file (600)
```

## What's Protected

### ✅ Never Committed to Git

The following are in `.gitignore`:

- `.env` - Environment configuration
- `.env.homelab` - Homelab-specific config
- `.env.gitlab` - GitLab integration config
- `.autogit_secrets` - Secrets file
- `.autogit_login_info` - Login credentials
- `*.token` - Any token files
- `*_password` - Any password files
- `*_secrets` - Any secrets files

### ✅ Secure File Permissions

All credential files are created with mode `600`:
- Readable only by the file owner
- Not readable by group or others
- Not writable by anyone except owner

## First-Time Setup Process

### 1. Run Setup Script

```bash
bash scripts/first-time-setup-complete.sh
```

### 2. What Happens

1. **GitLab becomes ready** - Waits for service startup
2. **Password generated** - 32-character random password
3. **Password stored** - Saved to `~/.autogit/gitlab_root_password`
4. **API token created** - Via GitLab Rails console
5. **Token stored** - Saved to `~/.autogit_secrets` and `.env.gitlab`
6. **Project created** - AutoGit project with CI/CD
7. **Credentials displayed** - Shown securely in terminal

### 3. Access Your Credentials

```bash
# View GitLab password
cat ~/.autogit/gitlab_root_password

# View all secrets
cat ~/.autogit_secrets

# View environment config
cat .env.gitlab
```

## GitLab Access

### Web UI Login

```
URL:      http://192.168.1.170:3000
Username: root
Password: [from ~/.autogit/gitlab_root_password]
```

### API Access

```bash
# Load configuration
source .env.gitlab

# Use API token
curl --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
  "${GITLAB_URL}/api/v4/projects"
```

## Security Best Practices

### ✅ DO

- ✅ Use the auto-generated passwords
- ✅ Keep `~/.autogit/` directory secure (700 permissions)
- ✅ Backup credentials to a secure location (e.g., password manager)
- ✅ Rotate tokens periodically
- ✅ Use `.env.example` as a template
- ✅ Review `.gitignore` before committing

### ❌ DON'T

- ❌ Commit `.env` or credential files to Git
- ❌ Share passwords in plain text
- ❌ Use weak or default passwords in production
- ❌ Store passwords in shell history
- ❌ Give others access to credential files

## Manual Password Generation

If you need to generate a password manually:

```bash
# Run the password generation script
bash scripts/generate-gitlab-password.sh
```

This will:
1. Generate a secure 32-character password
2. Store it in `~/.autogit/gitlab_root_password`
3. Update `.env` with the password
4. Set appropriate file permissions

## Token Rotation

To rotate the GitLab API token:

```bash
# The setup script automatically revokes old tokens
bash scripts/first-time-setup-complete.sh
```

Or manually via GitLab UI:
1. Login to GitLab
2. Go to: User Settings → Access Tokens
3. Revoke old token
4. Create new token
5. Update `.env.gitlab` with new token

## Backup & Recovery

### Backup Credentials

```bash
# Create encrypted backup
tar czf autogit-secrets-backup.tar.gz ~/.autogit .env.gitlab
gpg -c autogit-secrets-backup.tar.gz
rm autogit-secrets-backup.tar.gz

# Store autogit-secrets-backup.tar.gz.gpg securely
```

### Restore Credentials

```bash
# Decrypt and extract
gpg -d autogit-secrets-backup.tar.gz.gpg | tar xzf -
```

## Environment Variables

### GitLab Configuration

```bash
GITLAB_ROOT_PASSWORD=<auto-generated>  # GitLab root password
GITLAB_URL=http://192.168.1.170:3000   # GitLab URL
GITLAB_TOKEN=<auto-generated>          # API token
GITLAB_PROJECT_ID=1                     # Project ID
```

### Runner Configuration

```bash
RUNNER_CPU_LIMIT=4.0        # CPU cores per runner
RUNNER_MEM_LIMIT=6g         # RAM per runner
RUNNER_COOLDOWN_SECONDS=300 # Cooldown period
```

## Troubleshooting

### Lost Password

If you lose the GitLab root password:

```bash
# Reset via container
ssh homelab "DOCKER_HOST=unix:///run/user/1000/docker.sock \
  docker exec autogit-git-server gitlab-rake 'gitlab:password:reset[root]'"
```

### Invalid Token

If the API token stops working:

```bash
# Run setup to generate new token
bash scripts/first-time-setup-complete.sh
```

### Permission Denied

If you get permission errors:

```bash
# Fix permissions
chmod 600 ~/.autogit/*
chmod 600 .env.gitlab
chmod 600 .autogit_secrets
```

## Security Checklist

Before deployment, verify:

- [ ] All credential files have 600 permissions
- [ ] `.gitignore` includes all secret files
- [ ] No credentials in `.env.example`
- [ ] Password is auto-generated (not default)
- [ ] API token is unique
- [ ] Backup credentials are encrypted
- [ ] No credentials in commit history

## Additional Resources

- [GitLab Security Best Practices](https://docs.gitlab.com/ee/security/)
- [Docker Secrets Management](https://docs.docker.com/engine/swarm/secrets/)
- [OpenSSL Random](https://www.openssl.org/docs/man1.1.1/man1/rand.html)

---

**Remember**: Security is a continuous process. Regularly review and update your security practices.
